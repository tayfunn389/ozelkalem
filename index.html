<script>
    // **********************************************
    // 1. SUPABASE AYARLARI (Kendi bilgileriniz yerleştirildi)
    // **********************************************
    // Supabase Proje URL'si (Sizin verdiğiniz):
    const SUPABASE_URL = "https://cawfcbbbxnmrjwrwbndi.supabase.co"; 
    
    // Yayınlanabilir Anahtar (Publishable Key - Sizin verdiğiniz):
    const SUPABASE_KEY = "sb_publishable_plhigNnbk-OphzfCvL4vig_E7Z_RCnN";

    // --- GLOBAL DEĞİŞKENLER ---
    var rehberListesi = [];
    const aramaSonuclariElementi = document.getElementById("aramaSonuclari");
    const kategoriSecimElementi = document.getElementById("kategoriSecim");

    // ====================================================================
    // 2. VERİ ÇEKME VE DİNLEME (READ)
    // ====================================================================
    async function veriCekVeDinle() {
        try {
            // Tablodan tüm sütunları ve id'yi al, ad'a göre sırala. Tablo adı: rehber_kayitlari
            const response = await fetch(`${SUPABASE_URL}/rest/v1/rehber_kayitlari?select=*,id&order=ad.asc`, {
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}` 
                }
            });

            if (!response.ok) {
                // Hata mesajını konsolda göster
                const errorData = await response.json();
                throw new Error(`HTTP Hata: ${response.status}. Detay: ${JSON.stringify(errorData)}`);
            }
            
            const veri = await response.json(); 
            
            // Supabase verisini, uygulamanın beklediği formata çeviriyoruz:
            rehberListesi = veri.map(kisi => ({
                kayitID: kisi.id,       // Supabase ID'sini KayitID olarak kullanırız
                ad: kisi.ad || "",
                no: kisi.telefon || "", // Supabase'teki telefon sütununu kullanın
                kategori: kisi.kategori || "Genel"
            }));
            
            // Veri çekildikten sonra listeyi ve kategorileri güncelle
            kategorileriDoldur(rehberListesi);
            aramaYap(); 

        } catch (error) {
            console.error("Veri Çekme Hatası (Supabase):", error);
            aramaSonuclariElementi.innerHTML = `<div class="sonuc-satiri" style="justify-content: center; background: #f8d7da; color: #721c24; padding: 10px;">Supabase bağlantı veya okuma hatası. (Konsolu kontrol edin)</div>`;
        }
    }

    // ====================================================================
    // 3. YENİ KAYIT EKLEME (CREATE)
    // ====================================================================
    async function yeniKayitEkle() {
        const isim = document.getElementById("isimInput").value.trim();
        const tel = document.getElementById("telInput").value.trim();
        const kategori = kategoriSecimElementi.value;
        if (isim === "" || tel === "") { 
            alert("Lütfen hem isim hem de numara giriniz!"); 
            return; 
        }

        // Supabase tablonuzun sütun adlarına uygun payload
        const payload = { ad: isim, telefon: tel, kategori: kategori };

        const response = await fetch(`${SUPABASE_URL}/rest/v1/rehber_kayitlari`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Prefer': 'return=representation' 
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert(`${isim} başarıyla kaydedildi!`);
            veriCekVeDinle(); 
            document.getElementById("isimInput").value = "";
            document.getElementById("telInput").value = "";
        } else {
            const errorData = await response.json();
            console.error("Supabase Kayıt Hatası:", errorData);
            alert("Kayıt sırasında bir hata oluştu. Konsolu kontrol edin.");
        }
    }
    
    // ====================================================================
    // 4. KAYIT SİLME (DELETE)
    // ====================================================================
    async function sil(kayitID) {
        if (!confirm("Bu kaydı silmek istediğinizden emin misiniz?")) {
            return;
        }

        const response = await fetch(`${SUPABASE_URL}/rest/v1/rehber_kayitlari?id=eq.${kayitID}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`
            }
        });

        if (response.ok) {
            alert(`Kayıt silindi ve veritabanından kaldırıldı.`);
            veriCekVeDinle(); 
        } else {
            alert("Silme sırasında bir hata oluştu. Konsolu kontrol edin.");
        }
    }


    // ====================================================================
    // 5. YARDIMCI FONKSİYONLAR (Aynı Kalır)
    // ====================================================================
    
    function kategorileriDoldur(data) {
        // Kategorileri unique olarak bulur ve kategoriSecim dropdown'ını günceller
        const kategoriler = [...new Set(data.map(kisi => kisi.kategori))].filter(k => k);
        kategoriSecimElementi.innerHTML = `<option value="">TÜMÜ</option>`;
        kategoriler.forEach(kategori => {
            kategoriSecimElementi.innerHTML += `<option value="${kategori}">${kategori}</option>`;
        });
    }

    function aramaYap() {
        const aramaTerm = document.getElementById("aramaInput").value.toLowerCase();
        const seciliKategori = kategoriSecimElementi.value;
        let sonuclar = rehberListesi;

        // Kategoriye göre filtreleme
        if (seciliKategori) {
            sonuclar = sonuclar.filter(kisi => kisi.kategori === seciliKategori);
        }

        // Arama terimine göre filtreleme
        if (aramaTerm) {
            sonuclar = sonuclar.filter(kisi => 
                kisi.ad.toLowerCase().includes(aramaTerm) ||
                kisi.no.includes(aramaTerm)
            );
        }

        listeyiGoster(sonuclar);
    }
    
    function listeyiGoster(sonuclar) {
        if (sonuclar.length === 0) {
            aramaSonuclariElementi.innerHTML = `<div class="sonuc-satiri" style="justify-content: center; color: #888;">Sonuç bulunamadı.</div>`;
            return;
        }

        aramaSonuclariElementi.innerHTML = sonuclar.map(kisi => `
            <div class="sonuc-satiri">
                <div class="bilgi-alani">
                    <strong>${kisi.ad}</strong>
                    <span class="numara">${kisi.no}</span>
                </div>
                <div class="kategori-alani">${kisi.kategori}</div>
                <button onclick="sil('${kisi.kayitID}')" class="sil-button">Sil</button>
            </div>
        `).join('');
    }

    // Uygulama başlatıldığında verileri çek
    document.addEventListener('DOMContentLoaded', veriCekVeDinle);
    
    // Arama ve kategori değişikliklerini dinle
    document.getElementById("aramaInput").addEventListener('input', aramaYap);
    kategoriSecimElementi.addEventListener('change', aramaYap);
</script>
